{
    "version": "0.3.32-2",
    "description": "LM Studio is an easy-to-use desktop app for experimenting with local and open-source Large Language Models (LLMs).",
    "homepage": "https://lmstudio.ai/",
    "license": {
        "identifier": "Proprietary",
        "url": "https://lmstudio.ai/terms"
    },
    "architecture": {
        "64bit": {
            "url": "https://installers.lmstudio.ai/win32/x64/0.3.32-2/LM-Studio-0.3.32-2-x64.exe",
            "hash": "a0e522d9ad818ff823b94780de5803677fe6424d8ab916cbe372b40e460c8b24"
        }
    },
    "installer": {
        "script": [
            "7z x \"$dir\\$fname\" -o\"$dir\\extracted\" -y | Out-Null",
            "Move-Item \"$dir\\extracted\\`$PLUGINSDIR\\app-64.7z\" \"$dir\\app.7z\"",
            "7z x \"$dir\\app.7z\" -o\"$dir\" -y | Out-Null",
            "Remove-Item \"$dir\\extracted\", \"$dir\\app.7z\", \"$dir\\$fname\" -Recurse -Force"
        ]
    },
    "shortcuts": [
        [
            "LM Studio.exe",
            "LM Studio"
        ]
    ],
    "post_install": [
        "$homeConfig = Join-Path $persist_dir 'home\\config'",
        "$homeState = Join-Path $persist_dir 'home\\state'",
        "$lmStudioDir = Join-Path $homeConfig 'lm-studio'",
        "$roamingDir = Join-Path $persist_dir 'roaming'",
        "$localDir = Join-Path $persist_dir 'local'",
        "foreach ($path in @($homeConfig, $homeState, $lmStudioDir, $roamingDir, $localDir)) { if (-not (Test-Path $path)) { New-Item -ItemType Directory -Path $path -Force | Out-Null } }",
        "$legacyData = Join-Path $dir 'data'",
        "if (Test-Path $legacyData) {",
        "  $legacyRoaming = Join-Path $legacyData 'user-data'",
        "  if (Test-Path $legacyRoaming) { Copy-Item \"$legacyRoaming\\*\" $roamingDir -Force -Recurse -ErrorAction SilentlyContinue }",
        "  $legacyLocal = Join-Path $legacyData 'local-data'",
        "  if (Test-Path $legacyLocal) { Copy-Item \"$legacyLocal\\*\" $localDir -Force -Recurse -ErrorAction SilentlyContinue }",
        "  $legacyHome = Join-Path $legacyData 'lm-studio'",
        "  if (Test-Path $legacyHome) { Copy-Item \"$legacyHome\\*\" $lmStudioDir -Force -Recurse -ErrorAction SilentlyContinue }",
        "  Remove-Item $legacyData -Recurse -Force -ErrorAction SilentlyContinue",
        "}",
        "$localAppDataPath = Join-Path $env:LocalAppData 'LM-Studio'",
        "if (Test-Path $localAppDataPath -and -not (Get-Item $localAppDataPath).LinkType) { Copy-Item \"$localAppDataPath\\*\" $localDir -Force -Recurse -ErrorAction SilentlyContinue; Remove-Item $localAppDataPath -Recurse -Force -ErrorAction SilentlyContinue }",
        "$appDataPath = Join-Path $env:AppData 'LM Studio'",
        "if (Test-Path $appDataPath -and -not (Get-Item $appDataPath).LinkType) { Copy-Item \"$appDataPath\\*\" $roamingDir -Force -Recurse -ErrorAction SilentlyContinue; Remove-Item $appDataPath -Recurse -Force -ErrorAction SilentlyContinue }",
        "$homePointerPath = Join-Path $env:USERPROFILE '.lmstudio-home-pointer'",
        "$homePointerContent = $lmStudioDir",
        "$homePointerContent | Out-File -FilePath $homePointerPath -Encoding utf8 -Force",
        "#region scoop-portable-profile",
        "# Portable profile helpers for Scoop manifests.",
        "# 说明：构建阶段会把该文件的内容内联进 post_install/pre_uninstall。",
        "function Resolve-PortablePath {",
        "    param(",
        "        [string]$Path,",
        "        [hashtable]$Context",
        "    )",
        "    if ($Path -match '^AppData/(.+)$') {",
        "        return (Join-Path $env:AppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^LocalAppData/(.+)$') {",
        "        return (Join-Path $env:LocalAppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^ProgramData/(.+)$') {",
        "        return (Join-Path $env:ProgramData $matches[1])",
        "    }",
        "    elseif ($Path -match '^UserProfile/(.+)$') {",
        "        return (Join-Path $env:USERPROFILE $matches[1])",
        "    }",
        "    elseif ($Path -match '^\\$dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.Dir $suffix)",
        "    }",
        "    elseif ($Path -match '^\\$persist_dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.PersistDir $suffix)",
        "    }",
        "    else {",
        "        return ($ExecutionContext.InvokeCommand.ExpandString($Path))",
        "    }",
        "}",
        "function Ensure-PortableDirectory {",
        "    param([string]$Path)",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType Directory -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Ensure-PortableFile {",
        "    param([string]$Path)",
        "    $parent = Split-Path -Parent $Path",
        "    if ($parent) { Ensure-PortableDirectory $parent }",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType File -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Copy-PortableData {",
        "    param(",
        "        [string]$Source,",
        "        [string]$Destination",
        "    )",
        "    if (Test-Path $Source) {",
        "        Ensure-PortableDirectory $Destination",
        "        Copy-Item \"$Source\\*\" $Destination -Force -Recurse -ErrorAction SilentlyContinue",
        "    }",
        "}",
        "function New-PortableSymlink {",
        "    param(",
        "        [string]$Link,",
        "        [string]$Target",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType -and $item.Target -eq $Target) {",
        "            return",
        "        }",
        "        Remove-Item $Link -Recurse -Force -ErrorAction SilentlyContinue",
        "    }",
        "    New-Item -ItemType SymbolicLink -Path $Link -Target $Target -Force | Out-Null",
        "}",
        "function Remove-PortableLink {",
        "    param(",
        "        [string]$Link,",
        "        [switch]$Log",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType) {",
        "            Remove-Item $Link -Force -ErrorAction SilentlyContinue",
        "            if ($Log) {",
        "                info \"[Portable Mode] Removed symbolic link: $Link\"",
        "            }",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableCleanup {",
        "    param(",
        "        [hashtable]$Cleanup,",
        "        [hashtable]$Context",
        "    )",
        "    if (-not $Cleanup) {",
        "        return",
        "    }",
        "    foreach ($path in @($Cleanup.removeAfterMigrate)) {",
        "        if (-not $path) { continue }",
        "        $resolved = Resolve-PortablePath -Path $path -Context $Context",
        "        if (Test-Path $resolved) {",
        "            Remove-Item $resolved -Recurse -Force -ErrorAction SilentlyContinue",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableMappings {",
        "    param(",
        "        [ValidateSet('Install', 'Uninstall')] [string]$Action,",
        "        [hashtable]$Context,",
        "        [array]$Mappings,",
        "        [hashtable]$Cleanup,",
        "        [switch]$Log",
        "    )",
        "    foreach ($mapping in $Mappings) {",
        "        $sourcePath = Resolve-PortablePath -Path $mapping.Source -Context $Context",
        "        $targetPath = Resolve-PortablePath -Path $mapping.Target -Context $Context",
        "        $targetType = if ($mapping.TargetType) { $mapping.TargetType } else { 'directory' }",
        "        if ($Action -eq 'Install') {",
        "            if ($mapping.EnsureTarget) {",
        "                if ($targetType -eq 'file') {",
        "                    Ensure-PortableFile $targetPath",
        "                }",
        "                else {",
        "                    Ensure-PortableDirectory $targetPath",
        "                }",
        "            }",
        "            if ($targetType -ne 'file') {",
        "                foreach ($legacy in @($mapping.MigrateFrom)) {",
        "                    if (-not $legacy) { continue }",
        "                    $legacyPath = Resolve-PortablePath -Path $legacy -Context $Context",
        "                    Copy-PortableData -Source $legacyPath -Destination $targetPath",
        "                }",
        "                if ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                    Copy-PortableData -Source $sourcePath -Destination $targetPath",
        "                    Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "                }",
        "            }",
        "            elseif ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "            }",
        "            switch ($mapping.Strategy) {",
        "                'symlink' { New-PortableSymlink -Link $sourcePath -Target $targetPath }",
        "                Default { Copy-PortableData -Source $sourcePath -Destination $targetPath }",
        "            }",
        "            if ($Log) {",
        "                info \"[Portable Mode] Linked $($mapping.Label) -> $targetPath\"",
        "            }",
        "        }",
        "        else {",
        "            Remove-PortableLink -Link $sourcePath -Log:$Log",
        "        }",
        "    }",
        "    if ($Action -eq 'Install') {",
        "        Invoke-PortableCleanup -Cleanup $Cleanup -Context $Context",
        "    }",
        "}",
        "#endregion",
        "Invoke-PortableMappings -Action Install -Context @{ Dir = $dir; PersistDir = $persist_dir } -Mappings @(",
        "    @{ Label = 'roaming'; Source = 'AppData/LM Studio'; Target = \"$persist_dir/roaming\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory'; MigrateFrom = @(\"$dir/data/user-data\") },",
        "    @{ Label = 'local'; Source = 'LocalAppData/LM-Studio'; Target = \"$persist_dir/local\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory'; MigrateFrom = @(\"$dir/data/local-data\") },",
        "    @{ Label = 'updater'; Source = 'LocalAppData/lm-studio-updater'; Target = \"$persist_dir/local/lm-studio-updater\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'file'; MigrateFrom = @() }",
        ") -Cleanup @{ removeAfterMigrate = @(\"$dir/data\") } -Log:$true"
    ],
    "persist": "data",
    "checkver": {
        "url": "https://lmstudio.ai/download",
        "regex": "win32.*?x64.*?version.*?([\\d.]+).*?build.*?([\\d]+)",
        "replace": "${1}-${2}"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "https://installers.lmstudio.ai/win32/x64/$version/LM-Studio-$version-x64.exe"
            }
        }
    },
    "pre_uninstall": [
        "#region scoop-portable-profile",
        "# Portable profile helpers for Scoop manifests.",
        "# 说明：构建阶段会把该文件的内容内联进 post_install/pre_uninstall。",
        "function Resolve-PortablePath {",
        "    param(",
        "        [string]$Path,",
        "        [hashtable]$Context",
        "    )",
        "    if ($Path -match '^AppData/(.+)$') {",
        "        return (Join-Path $env:AppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^LocalAppData/(.+)$') {",
        "        return (Join-Path $env:LocalAppData $matches[1])",
        "    }",
        "    elseif ($Path -match '^ProgramData/(.+)$') {",
        "        return (Join-Path $env:ProgramData $matches[1])",
        "    }",
        "    elseif ($Path -match '^UserProfile/(.+)$') {",
        "        return (Join-Path $env:USERPROFILE $matches[1])",
        "    }",
        "    elseif ($Path -match '^\\$dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.Dir $suffix)",
        "    }",
        "    elseif ($Path -match '^\\$persist_dir(?<rest>[/\\\\].*)?$') {",
        "        $suffix = $matches['rest']",
        "        if ($suffix) {",
        "            $suffix = ($suffix -replace '^[/\\\\]+', '')",
        "            $suffix = $suffix.Replace('/', '\\\\')",
        "        }",
        "        return (Join-Path $Context.PersistDir $suffix)",
        "    }",
        "    else {",
        "        return ($ExecutionContext.InvokeCommand.ExpandString($Path))",
        "    }",
        "}",
        "function Ensure-PortableDirectory {",
        "    param([string]$Path)",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType Directory -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Ensure-PortableFile {",
        "    param([string]$Path)",
        "    $parent = Split-Path -Parent $Path",
        "    if ($parent) { Ensure-PortableDirectory $parent }",
        "    if (-not (Test-Path $Path)) {",
        "        New-Item -ItemType File -Path $Path -Force | Out-Null",
        "    }",
        "}",
        "function Copy-PortableData {",
        "    param(",
        "        [string]$Source,",
        "        [string]$Destination",
        "    )",
        "    if (Test-Path $Source) {",
        "        Ensure-PortableDirectory $Destination",
        "        Copy-Item \"$Source\\*\" $Destination -Force -Recurse -ErrorAction SilentlyContinue",
        "    }",
        "}",
        "function New-PortableSymlink {",
        "    param(",
        "        [string]$Link,",
        "        [string]$Target",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType -and $item.Target -eq $Target) {",
        "            return",
        "        }",
        "        Remove-Item $Link -Recurse -Force -ErrorAction SilentlyContinue",
        "    }",
        "    New-Item -ItemType SymbolicLink -Path $Link -Target $Target -Force | Out-Null",
        "}",
        "function Remove-PortableLink {",
        "    param(",
        "        [string]$Link,",
        "        [switch]$Log",
        "    )",
        "    if (Test-Path $Link) {",
        "        $item = Get-Item $Link -ErrorAction SilentlyContinue",
        "        if ($item -and $item.LinkType) {",
        "            Remove-Item $Link -Force -ErrorAction SilentlyContinue",
        "            if ($Log) {",
        "                info \"[Portable Mode] Removed symbolic link: $Link\"",
        "            }",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableCleanup {",
        "    param(",
        "        [hashtable]$Cleanup,",
        "        [hashtable]$Context",
        "    )",
        "    if (-not $Cleanup) {",
        "        return",
        "    }",
        "    foreach ($path in @($Cleanup.removeAfterMigrate)) {",
        "        if (-not $path) { continue }",
        "        $resolved = Resolve-PortablePath -Path $path -Context $Context",
        "        if (Test-Path $resolved) {",
        "            Remove-Item $resolved -Recurse -Force -ErrorAction SilentlyContinue",
        "        }",
        "    }",
        "}",
        "function Invoke-PortableMappings {",
        "    param(",
        "        [ValidateSet('Install', 'Uninstall')] [string]$Action,",
        "        [hashtable]$Context,",
        "        [array]$Mappings,",
        "        [hashtable]$Cleanup,",
        "        [switch]$Log",
        "    )",
        "    foreach ($mapping in $Mappings) {",
        "        $sourcePath = Resolve-PortablePath -Path $mapping.Source -Context $Context",
        "        $targetPath = Resolve-PortablePath -Path $mapping.Target -Context $Context",
        "        $targetType = if ($mapping.TargetType) { $mapping.TargetType } else { 'directory' }",
        "        if ($Action -eq 'Install') {",
        "            if ($mapping.EnsureTarget) {",
        "                if ($targetType -eq 'file') {",
        "                    Ensure-PortableFile $targetPath",
        "                }",
        "                else {",
        "                    Ensure-PortableDirectory $targetPath",
        "                }",
        "            }",
        "            if ($targetType -ne 'file') {",
        "                foreach ($legacy in @($mapping.MigrateFrom)) {",
        "                    if (-not $legacy) { continue }",
        "                    $legacyPath = Resolve-PortablePath -Path $legacy -Context $Context",
        "                    Copy-PortableData -Source $legacyPath -Destination $targetPath",
        "                }",
        "                if ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                    Copy-PortableData -Source $sourcePath -Destination $targetPath",
        "                    Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "                }",
        "            }",
        "            elseif ((Test-Path $sourcePath) -and -not (Get-Item $sourcePath -ErrorAction SilentlyContinue).LinkType) {",
        "                Remove-Item $sourcePath -Recurse -Force -ErrorAction SilentlyContinue",
        "            }",
        "            switch ($mapping.Strategy) {",
        "                'symlink' { New-PortableSymlink -Link $sourcePath -Target $targetPath }",
        "                Default { Copy-PortableData -Source $sourcePath -Destination $targetPath }",
        "            }",
        "            if ($Log) {",
        "                info \"[Portable Mode] Linked $($mapping.Label) -> $targetPath\"",
        "            }",
        "        }",
        "        else {",
        "            Remove-PortableLink -Link $sourcePath -Log:$Log",
        "        }",
        "    }",
        "    if ($Action -eq 'Install') {",
        "        Invoke-PortableCleanup -Cleanup $Cleanup -Context $Context",
        "    }",
        "}",
        "#endregion",
        "Invoke-PortableMappings -Action Uninstall -Context @{ Dir = $dir; PersistDir = $persist_dir } -Mappings @(",
        "    @{ Label = 'roaming'; Source = 'AppData/LM Studio'; Target = \"$persist_dir/roaming\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory'; MigrateFrom = @(\"$dir/data/user-data\") },",
        "    @{ Label = 'local'; Source = 'LocalAppData/LM-Studio'; Target = \"$persist_dir/local\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'directory'; MigrateFrom = @(\"$dir/data/local-data\") },",
        "    @{ Label = 'updater'; Source = 'LocalAppData/lm-studio-updater'; Target = \"$persist_dir/local/lm-studio-updater\"; Strategy = 'symlink'; EnsureTarget = $true; TargetType = 'file'; MigrateFrom = @() }",
        ") -Cleanup @{ removeAfterMigrate = @(\"$dir/data\") } -Log:$true"
    ]
}
