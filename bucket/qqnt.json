{
    "version": "9.9.15.240822",
    "homepage": "https://im.qq.com/pcqq/index.shtml",
    "description": "(LiteLoaderQQNT patch) An instant messaging software service developed by Tencent, build with Electron.",
    "license": {
        "identifier": "Proprietary",
        "url": "https://ti.qq.com/agreement/index.html"
    },
    "depends": [
        "LiteLoaderQQNT",
        "QQNTPatcher-DllHijack"
    ],
    "architecture": {
        "64bit": {
            "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_9.9.15_240822_x64_01.exe#/dl.7z",
            "hash": "af604fca48757a5c9269498f30f0dc7fa9fd1bf7566bfdf9923db02f0330cf6c"
        },
        "32bit": {
            "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_9.9.15_240822_x86_01.exe#/dl.7z",
            "hash": "a62fbba62d80ef8fce690322a41652d848d991fc98b02ba0241bc10b5c14b5fc"
        },
        "arm64": {
            "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_9.9.15_240822_arm64_01.exe#/dl.7z",
            "hash": "afdd2a63fff0d672230dc466b715b5380e2f96bb2eb4f2bf5429880fe9c4120b"
        }
    },
    "extract_dir": "Files",
    "shortcuts": [
        [
            "QQ.exe",
            "QQ"
        ]
    ],
    "persist": [
        "dbghelp.dll",
        "resources\\app\\app_launcher\\PatchConfig.json"
    ],
    "pre_install": [
        "Import-Module $(Join-Path $(Find-BucketDirectory -Root -Name air) scripts/AirUtils.psm1)",
        "$patch_dll = \"$persist_dir\\dbghelp.dll\"",
        "if (!(Test-Path $patch_dll)) {",
        "    $hijack_dir = scoop prefix 'QQNTPatcher-DllHijack'",
        "    $arch = switch ($architecture) {",
        "        'arm64' { 'arm64' }",
        "        '64bit' { 'x64' }",
        "        default { 'x86' }",
        "    }",
        "    EnsureHardLink $patch_dll \"$hijack_dir\\dbghelp_$arch.dll\"",
        "}",
        "$patch_json = \"$persist_dir\\resources\\app\\app_launcher\\PatchConfig.json\"",
        "if (!(Test-Path $patch_json)) {",
        "    $loader_dir = scoop prefix 'LiteLoaderQQNT'",
        "    $patch_config = @{ LLPath = $loader_dir } | ConvertTo-Json",
        "    EnsureSetContent $patch_json $patch_config",
        "}",
        "Remove-Module -Name AirUtils"
    ],
    "post_install": [
        "$versions_dir = \"$dir\\resources\\app\\versions\"",
        "Get-ChildItem $versions_dir -Filter '*.zip' | Select-Object -First 1 | ForEach-Object {",
        "    $destination = Join-Path $versions_dir $_.BaseName",
        "    Expand-Archive $_.FullName -DestinationPath $destination -Force",
        "    Remove-Item $_.FullName -Force",
        "}"
    ],
    "checkver": {
        "script": [
            "$html = Invoke-WebRequest -Uri \"https://im.qq.com/pcqq/index.shtml\" -UseBasicParsing",
            "$regex1 = '//.*/im.qq.com_new/.*/windowsDownloadUrl\\.js(\\?t=[0-9]+)?'",
            "$links = ([regex]::Matches($html.Content, $regex1)).value",
            "$allContent = $links | ForEach-Object { (Invoke-WebRequest -Uri ('https:' + $_) -UseBasicParsing).Content } | Out-String",
            "$regex2 = 'QQNT/Windows/QQ_([0-9.]+)_([0-9]+)_x64_01.exe'",
            "(([regex]::Matches($allContent, $regex2)).value | Sort-Object -Descending -CaseSensitive)[0] | Out-String"
        ],
        "regex": "QQNT/Windows/QQ_([\\d\\.]+)_([\\d]+)_x64_01.exe",
        "replace": "${1}.${2}"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_$match1_$match2_x64_01.exe#/dl.7z"
            },
            "32bit": {
                "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_$match1_$match2_x86_01.exe#/dl.7z"
            },
            "arm64": {
                "url": "https://dldir1.qq.com/qqfile/qq/QQNT/Windows/QQ_$match1_$match2_arm64_01.exe#/dl.7z"
            }
        }
    }
}
